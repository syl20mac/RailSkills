# RÃ¨gles Cursor IA - RailSkills iOS

## ğŸ¯ Contexte du Projet

**RailSkills** est une application iOS/iPadOS native pour la SNCF permettant aux CTT (Cadres Transport Traction) et ARC (Adjoints RÃ©fÃ©rents Conduite) de gÃ©rer le suivi triennal rÃ©glementaire des conducteurs circulant au Luxembourg.

**Version :** 2.0+  
**Plateforme :** iOS 16+ / iPadOS 16+  
**Technologies :** SwiftUI, Combine, MVVM, Microsoft Graph API

---

## ğŸ—ï¸ Architecture

### Pattern : MVVM (Model-View-ViewModel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        View Layer                            â”‚
â”‚  (SwiftUI Views - Pas de logique mÃ©tier)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      ViewModel Layer                         â”‚
â”‚  (Combine - Gestion d'Ã©tat, transformations)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Service Layer                          â”‚
â”‚  (Store, SharePoint, Export, PDF, Encryption)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Model Layer                           â”‚
â”‚  (Codable - Structures de donnÃ©es)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Structure des Dossiers

- **Models/** : Structures de donnÃ©es pures (Codable, Identifiable, Hashable)
- **Services/** : Logique mÃ©tier, persistance, synchronisation
- **ViewModels/** : Logique de prÃ©sentation, gestion d'Ã©tat avec Combine
- **Views/** : Interface utilisateur SwiftUI (pas de logique mÃ©tier)
- **Utilities/** : Extensions, helpers, constants

---

## ğŸ“ Conventions de Code

### Nommage

- **Classes/Structs/Enums** : PascalCase (`DriverRecord`, `SharePointSyncService`)
- **Variables/Fonctions** : camelCase (`selectedDriver`, `syncData()`)
- **Constantes** : camelCase ou PascalCase selon contexte
- **Fichiers** : PascalCase correspondant au nom de la classe principale

### Organisation des Fichiers

- Utiliser `// MARK: - Section Name` pour organiser le code
- Grouper par fonctionnalitÃ© (propriÃ©tÃ©s, initialisation, mÃ©thodes publiques, mÃ©thodes privÃ©es)
- Placer les extensions en fin de fichier
- Documenter toutes les fonctions publiques avec `///`

### Commentaires

- **Toujours commenter en franÃ§ais** pour les futures maintenances
- Utiliser `///` pour la documentation publique
- Utiliser `//` pour les commentaires internes
- Inclure des headers de fichier avec la description

### Exemple de Header de Fichier

```swift
//
//  NomFichier.swift
//  RailSkills
//
//  Description du fichier et son rÃ´le
//
```

---

## ğŸ”§ Patterns Ã  Suivre

### 1. Logging

**Toujours utiliser le Logger centralisÃ©** :

```swift
Logger.info("Message informatif", category: "ComponentName")
Logger.success("OpÃ©ration rÃ©ussie", category: "ComponentName")
Logger.error("Erreur: \(error.localizedDescription)", category: "ComponentName")
Logger.debug("DÃ©tails de debug", category: "ComponentName")
Logger.warning("Avertissement", category: "ComponentName")
```

**CatÃ©gories recommandÃ©es** : "SharePointSync", "AppViewModel", "Store", "ExportService", etc.

### 2. Async/Await pour OpÃ©rations RÃ©seau

```swift
func syncData() async throws {
    Logger.info("DÃ©but de la synchronisation", category: "SharePointSync")
    
    do {
        let data = try await service.fetch()
        // Traiter les donnÃ©es
        Logger.success("Synchronisation rÃ©ussie", category: "SharePointSync")
    } catch {
        Logger.error("Erreur de synchronisation: \(error.localizedDescription)", category: "SharePointSync")
        throw error
    }
}
```

### 3. Combine pour Gestion d'Ã‰tat

```swift
final class AppViewModel: ObservableObject {
    @Published var store = Store()
    @Published var selectedDriverIndex: Int = 0
    
    private var cancellables = Set<AnyCancellable>()
    
    init() {
        store.objectWillChange
            .receive(on: RunLoop.main)
            .sink { [weak self] _ in
                self?.objectWillChange.send()
            }
            .store(in: &cancellables)
    }
}
```

### 4. Main Actor pour UI

```swift
@MainActor
class SharePointSyncService: ObservableObject {
    @Published var isSyncing = false
    
    func sync() async {
        // Code exÃ©cutÃ© sur le thread principal
    }
}
```

### 5. Gestion d'Erreurs

Toujours utiliser des types d'erreur spÃ©cifiques :

```swift
enum SharePointSyncError: LocalizedError {
    case siteNotFound(String)
    case invalidResponse(String)
    case authenticationFailed
    
    var errorDescription: String? {
        switch self {
        case .siteNotFound(let message):
            return "Site SharePoint non trouvÃ©: \(message)"
        case .invalidResponse(let message):
            return "RÃ©ponse invalide: \(message)"
        case .authenticationFailed:
            return "Ã‰chec de l'authentification"
        }
    }
}
```

---

## ğŸ¨ UI/UX

### Couleurs SNCF

Utiliser les couleurs dÃ©finies dans `SNCFColors.swift` :

```swift
SNCFColors.primary
SNCFColors.secondary
SNCFColors.success
SNCFColors.warning
SNCFColors.error
```

### Responsive Design

- **iPad** : Utiliser `NavigationSplitView` pour sidebar + detail
- **iPhone** : Utiliser `NavigationStack` 
- Adapter les layouts avec `.environment(\.horizontalSizeClass, .compact)`

### AccessibilitÃ©

- Toujours ajouter des labels VoiceOver : `.accessibilityLabel("Description")`
- Support Dynamic Type : ne pas utiliser de tailles fixes
- Contraste suffisant : respecter WCAG 2.1 niveau AA

---

## ğŸ”’ SÃ©curitÃ©

### Secrets et Configuration

- **JAMAIS de secrets hardcodÃ©s** dans le code
- Utiliser `BackendConfig` pour la configuration
- Utiliser `AzureADConfig` pour Azure AD (depuis fichiers de config)
- Stocker les secrets sensibles dans la Keychain si nÃ©cessaire

### Chiffrement

- Utiliser `EncryptionService` pour chiffrer les donnÃ©es sensibles
- Utiliser AES-GCM pour le chiffrement

---

## ğŸ“¦ Services Principaux

### Store.swift
- Persistance avec UserDefaults
- Sauvegarde automatique avec dÃ©bouncing
- Filtrage par `ownerSNCFId`

### SharePointSyncService.swift
- Synchronisation avec SharePoint via Microsoft Graph API
- Support backend ou authentification locale
- Gestion des conflits

### ExportService.swift
- Export/Import JSON avec compression LZFSE
- Format `ShareableDriverRecord` pour le partage

### PDFReportGenerator.swift
- GÃ©nÃ©ration de rapports PDF avec en-tÃªtes

### EncryptionService.swift
- Chiffrement des donnÃ©es sensibles

---

## ğŸš« Anti-Patterns Ã  Ã‰viter

1. âŒ **Pas de logique mÃ©tier dans les Views** : Toute logique doit Ãªtre dans ViewModel ou Service
2. âŒ **Pas de `print()`** : Toujours utiliser `Logger`
3. âŒ **Pas de force unwrap** : Utiliser guard let ou if let
4. âŒ **Pas de secrets hardcodÃ©s** : Toujours utiliser la configuration
5. âŒ **Pas de tailles fixes** : Utiliser Dynamic Type et layouts adaptatifs
6. âŒ **Pas de threads UI non sÃ©curisÃ©s** : Utiliser `@MainActor` ou `DispatchQueue.main`

---

## âœ… Checklist Avant de Commiter

- [ ] Code commentÃ© en franÃ§ais
- [ ] Logger utilisÃ© au lieu de print()
- [ ] Gestion d'erreurs complÃ¨te
- [ ] Tests sur iPad rÃ©el (si modification UI)
- [ ] VoiceOver testÃ© (si nouvelle UI)
- [ ] Pas de secrets hardcodÃ©s
- [ ] Documentation des fonctions publiques
- [ ] MARK: utilisÃ©s pour organisation
- [ ] Pas de force unwrap dangereux

---

## ğŸ”„ Flux de DonnÃ©es

1. **Lecture** : View â†’ ViewModel â†’ Service â†’ Model â†’ UserDefaults
2. **Ã‰criture** : View â†’ ViewModel â†’ Service â†’ UserDefaults (avec dÃ©bouncing)
3. **Export** : ViewModel â†’ ExportService â†’ QRCodeService â†’ View
4. **Import** : View â†’ ExportService â†’ ViewModel â†’ Service â†’ UserDefaults
5. **Sync** : ViewModel â†’ SharePointSyncService â†’ Microsoft Graph API â†’ SharePoint

---

---

## ğŸ”— CompatibilitÃ© iOS â†” Web

### Formats de DonnÃ©es PartagÃ©s

- **Format JSON** : Toujours utiliser `ShareableDriverRecord` comme rÃ©fÃ©rence pour le partage
- **Champs obligatoires** : `id`, `name`, `checklistStates`, `checklistNotes`, `checklistDates`
- **Champs optionnels** : `firstName`, `cpNumber`, `lastEvaluation`, `triennialStart`, `ownerSNCFId`
- **Dates** : Format ISO 8601 (string) dans JSON pour compatibilitÃ© cross-platform
- **UUID** : Format standard avec tirets pour compatibilitÃ©

### Chiffrement

- **Algorithme** : AES-GCM (compatible entre iOS et Web)
- **Format dÃ©tection** : Utiliser `EncryptionService.isEncrypted()` pour dÃ©tecter les fichiers chiffrÃ©s
- **Secret organisationnel** : MÃªme secret utilisÃ© des deux cÃ´tÃ©s pour dÃ©chiffrement
- **Structure chiffrÃ©e** : PrÃ©fixe `ENCRYPTED:` suivi des donnÃ©es base64

### Structure SharePoint (OBLIGATOIRE)

**Structure par CTT** (pas de dossier global) :

```
RailSkills/
â””â”€â”€ CTT_{cttId}/           # Dossier par CTT (cttId = email SNCF)
    â”œâ”€â”€ Data/
    â”‚   â””â”€â”€ {nom-conducteur}/
    â”‚       â”œâ”€â”€ {nom-conducteur}.json         # Version actuelle
    â”‚       â””â”€â”€ {nom-conducteur}_backup.json  # Backup unique (Ã©crasÃ©)
    â””â”€â”€ Checklists/
        â”œâ”€â”€ {titre-checklist}.json
        â””â”€â”€ {titre-checklist}_backup.json
```

**RÃ¨gles strictes** :
- âœ… Toujours crÃ©er le dossier CTT si inexistant
- âœ… Ne jamais Ã©crire dans un dossier CTT d'un autre utilisateur
- âœ… Filtrer les lectures par `ownerSNCFId` ou `cttId`
- âœ… Valider l'appartenance avant lecture/Ã©criture
- âŒ PAS d'archives horodatÃ©es multiples (1 principal + 1 backup uniquement)

---

## ğŸ”’ SÃ©curitÃ© RenforcÃ©e

### Secrets et Tokens

- âŒ **JAMAIS** de secrets dans le code source
- âŒ **JAMAIS** de tokens dans les logs (mÃªme en debug)
- âœ… VÃ©rifier les secrets au dÃ©marrage et arrÃªter si manquants

### Logs SÃ©curisÃ©s

```swift
// âœ… BON
Logger.info("Synchronisation de \(driver.name)", category: "Sync")
Logger.error("Erreur: \(error.localizedDescription)", category: "Sync")

// âŒ MAUVAIS - JAMAIS logger les secrets ou tokens
Logger.info("Token: \(accessToken)", category: "Auth")  // âŒ
Logger.info("Secret: \(clientSecret)", category: "Auth")  // âŒ
```

### Isolation des DonnÃ©es

- âœ… Un CTT ne peut lire que ses propres donnÃ©es
- âœ… VÃ©rifier `ownerSNCFId` ou `cttId` avant chaque opÃ©ration SharePoint
- âœ… Ne jamais exposer les donnÃ©es d'un autre CTT

---

## ğŸ§ª Tests et Validation

### Tests Manuels Obligatoires

Avant de commiter une fonctionnalitÃ© :
- [ ] Test sur iPad rÃ©el (pas seulement simulateur)
- [ ] Test VoiceOver si modification UI
- [ ] Test mode sombre
- [ ] Test Dynamic Type (tailles extrÃªmes)
- [ ] Test synchronisation SharePoint
- [ ] Test import/export JSON
- [ ] Test dÃ©connexion rÃ©seau (mode offline)

### Tests de CompatibilitÃ©

Lors de modification des formats de donnÃ©es :
- [ ] Tester import d'un JSON iOS dans Web
- [ ] Tester export depuis Web et import dans iOS
- [ ] VÃ©rifier que le dÃ©chiffrement fonctionne des deux cÃ´tÃ©s
- [ ] VÃ©rifier la structure SharePoint gÃ©nÃ©rÃ©e

---

## ğŸ“Š Performance

### Optimisations iOS

- âœ… Utiliser le cache pour Ã©viter les calculs rÃ©pÃ©titifs (voir AppViewModel.cachedProgress)
- âœ… DÃ©bouncing pour les sauvegardes (Store.swift)
- âœ… Lazy loading pour les listes longues
- âœ… Cache des IDs de site SharePoint (Ã©viter appels rÃ©pÃ©tÃ©s)

---

## ğŸ“š Ressources

### Documentation Locale

- Documentation architecture : `Documentation/ARCHITECTURE.md`
- Guide d'amÃ©liorations : `Documentation/railskills-improvements.md`
- PRD : `Documentation/PRD_RailSkills_v2.0.md`
- CompatibilitÃ© Web : `Documentation/PRD_RailSkills-Web_NAS.md`

### Documentation Officielle (RÃ©fÃ©rence)

**Note :** Les liens ci-dessous sont des rÃ©fÃ©rences. Pour que Cursor IA les utilise, mentionnez-les explicitement dans vos prompts ou consultez-les directement.

#### Swift & SwiftUI
- Swift Language Guide : https://docs.swift.org/swift-book/
- SwiftUI Documentation : https://developer.apple.com/documentation/swiftui
- Human Interface Guidelines : https://developer.apple.com/design/human-interface-guidelines
- Apple Developer Documentation : https://developer.apple.com/documentation/

#### Combine
- Combine Framework : https://developer.apple.com/documentation/combine

#### Microsoft Graph API
- Microsoft Graph API Documentation : https://learn.microsoft.com/en-us/graph/overview
- SharePoint REST API : https://learn.microsoft.com/en-us/graph/api/resources/sharepoint
- Authentication (Azure AD) : https://learn.microsoft.com/en-us/graph/auth/

#### Bonnes Pratiques iOS
- Swift API Design Guidelines : https://www.swift.org/documentation/api-design-guidelines/
- iOS App Store Review Guidelines : https://developer.apple.com/app-store/review/guidelines/
- WWDC Sessions : https://developer.apple.com/videos/

### Bonnes Pratiques SwiftUI (RÃ©sumÃ© pour Cursor IA)

Selon les Human Interface Guidelines :

- **Typography** : Utiliser `.font(.system(.body))` pour s'adapter Ã  Dynamic Type
- **Colors** : Utiliser `Color.primary` et `Color.secondary` pour s'adapter au mode sombre
- **Spacing** : Minimum 8pt entre Ã©lÃ©ments, 16pt entre sections
- **Touch Targets** : Minimum 44x44 points pour les zones interactives
- **Safe Areas** : Toujours respecter avec `.safeAreaInset()` ou padding appropriÃ©
- **Accessibility** : Ajouter `.accessibilityLabel()` et `.accessibilityHint()` sur tous les Ã©lÃ©ments interactifs
- **Contrast** : Respecter WCAG 2.1 niveau AA (ratio 4.5:1 pour texte normal)

### Bonnes Pratiques Microsoft Graph API

- **Endpoints SharePoint** : Utiliser `/sites/{site-id}` pour les opÃ©rations sur site
- **Upload fichiers** : Utiliser `/sites/{site-id}/drive/items/{item-id}/content`
- **Liste fichiers** : Utiliser `/sites/{site-id}/drive/root/children` avec filtres
- **Authentification** : Token OAuth 2.0 avec scope `https://graph.microsoft.com/.default`
- **Gestion erreurs** : VÃ©rifier codes HTTP 429 (rate limit) et 503 (service unavailable)
- **Cache** : Cacher les tokens avec expiration (5 min de marge avant expiry)

